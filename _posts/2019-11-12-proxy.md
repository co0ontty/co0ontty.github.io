---
qlayout: post
title: "负载均衡代理池搭建教程" 
date: 2019-11-12 10:18:43
author: co0ontty
categories: 安全开发 ALL
tags: 安全开发 ALL
describe: 负载均衡代理池搭建
cover: '/assets/img/posts/balance.jpeg'
---

## 负载均衡代理池
> [源码](https://github.com/co0ontty/vuls-env/tree/master/work_env/ngxbalance)

该代理池使用 docker 进行部署，使用 nginx 进行动态切换的实现，使用 tinyproxy + squid3 + shadowsocks 实现代理功能

![nginx负载均衡代理池](/assets/img/posts/Jietu20191112-112320.png)

## 搭建过程

- 1.下载源码

> git clone https://github.com/co0ontty/vuls-env.git

- 2.代理节点部署

```bash
# tinyproxy
docker run -it -p 335:8888 -d co0ontty/proxy:tinyproxy
# squid3
docker run -it -p 334:3128 -d co0ontty/proxy:squid3
# shadowsocks
docker run -it -p 336:1234 -d co0ontty/proxy:shadowsocks
```

其中 tinyproxy 和 squid3 的代理运行后可以直接使用，shadowsocks 的代理运行后无法使用 nginx 直接进行调用，需要配合 sslocal 进行使用

- 3.nginx 负载均衡

```bash
## 根据需要编辑源码中的代理服务器配置文件，配置文件为项目根目录下的 nginx.conf
stream {
    upstream proxbalance {
		server 123.123.123.123:123;
    }
    server {
        listen 80;
        proxy_responses 1;
        proxy_timeout 20s;
        proxy_pass proxbalance;
    }
}
## 添加多条类似于 server 123.123.123.123:123; 的配置信息
## 使用 dockerfile 打包运行 nginx 负载均衡
docker build -t nginxbalance .
docker run -it -p 333:80 -d nginxbalance
```

- 负载均衡使用

将需要使用代理的地方填入 nginx 的 333 端口，nginx 将动态分配代理节点以供使用。

- 日志查看

docker logs {CONTAINER ID}

![](/assets/img/posts/Jietu20191112-112959.png)

![](/assets/img/posts/Jietu20191112-112806.png)

